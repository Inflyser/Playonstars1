—Å–º–æ—Ç—Ä–∏


–∫–æ–¥ –∏–≥—Ä—ã

import math
import random
from datetime import datetime
from sqlalchemy.orm import Session
from app.database.session import SessionLocal
from app.database import crud
from app.database.models import User
import asyncio



class CrashGame:
    def __init__(self, ws_manager):
        self.ws_manager = ws_manager
        self.current_multiplier = 1.0
        self.is_playing = False
        self.bets = {}
        self.game_history = []
        self.game_id = 0
        self.settings = None

    def load_settings(self, db: Session):
        """–ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ë–î"""
        from app.database import crud
        self.settings = crud.get_crash_game_settings(db)
        return self.settings

    def generate_multiplier(self) -> float:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–Ω–æ–∂–∏—Ç–µ–ª—è —Å —É—á–µ—Ç–æ–º RTP –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        if not self.settings:
            return round(random.uniform(1.1, 10.0), 2)
        
        # –ë–∞–∑–æ–≤–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫—Ä–∞—Ö–∞ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç RTP)
        base_crash_probability = 1 - self.settings.rtp
        
        # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
        adjusted_probability = base_crash_probability * self.settings.volatility
        
        # –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        if self.settings.crash_point_distribution == 'exponential':
            multiplier = self._generate_exponential_multiplier(adjusted_probability)
        elif self.settings.crash_point_distribution == 'uniform':
            multiplier = self._generate_uniform_multiplier()
        else:
            multiplier = self._generate_custom_multiplier(adjusted_probability)
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∏–Ω/–º–∞–∫—Å –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        multiplier = max(self.settings.min_multiplier, 
                        min(self.settings.max_multiplier, multiplier))
        
        return round(multiplier, 2)

    def _generate_exponential_multiplier(self, crash_probability: float) -> float:
        """–≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∫—Ä–∞—à)"""
        random_val = random.random()
        if random_val < crash_probability:
            return self.settings.min_multiplier
        
        multiplier = (1 - crash_probability) / (1 - random_val)
        return multiplier

    def _generate_uniform_multiplier(self) -> float:
        """–†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ"""
        return random.uniform(self.settings.min_multiplier, self.settings.max_multiplier)

    def _generate_custom_multiplier(self, crash_probability: float) -> float:
        """–ö–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏"""
        if self.settings.volatility > 1.5 and random.random() < 0.3:
            return self.settings.min_multiplier
        
        base = random.normalvariate(2.0, self.settings.volatility)
        corrected = base * (1 + (1 - self.settings.rtp))
        return corrected
    async def run_game_cycle(self):
        """–ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ –∏–≥—Ä—ã —Å —É—á–µ—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        db = SessionLocal()
        self.load_settings(db)
        db.close()
        
        self.game_id += 1
        self.is_playing = True
        self.bets.clear()
        
        # –§–∞–∑–∞ –ø—Ä–∏–µ–º–∞ —Å—Ç–∞–≤–æ–∫
        await self.ws_manager.send_crash_update({
            "game_id": self.game_id,
            "phase": "betting",
            "time_remaining": 15,
            "multiplier": 1.0,
            "settings": {
                "rtp": self.settings.rtp if self.settings else 0.95,
                "min_multiplier": self.settings.min_multiplier if self.settings else 1.1,
                "max_multiplier": self.settings.max_multiplier if self.settings else 100.0
            }
        })
        
        # –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–∏–µ–º–∞ —Å—Ç–∞–≤–æ–∫ (15 —Å–µ–∫—É–Ω–¥)
        for i in range(15, 0, -1):
            await asyncio.sleep(1)
            if not self.is_playing:
                return
            await self.ws_manager.send_crash_update({
                "game_id": self.game_id,
                "phase": "betting", 
                "time_remaining": i,
                "multiplier": 1.0
            })

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å
        multiplier = self.generate_multiplier()
        
        # –§–∞–∑–∞ –ø–æ–ª–µ—Ç–∞
        current_multiplier = 1.0
        step = 0.01
        
        while current_multiplier < multiplier and self.is_playing:
            await asyncio.sleep(0.1)
            current_multiplier += step
            current_multiplier = round(current_multiplier, 2)
            
            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à–∞–≥ –¥–ª—è –±–æ–ª—å—à–∏—Ö –º–Ω–æ–∂–∏—Ç–µ–ª–µ–π
            if current_multiplier > 5:
                step = 0.05
            elif current_multiplier > 2:
                step = 0.02
            
            await self.ws_manager.send_crash_update({
                "game_id": self.game_id,
                "phase": "flying",
                "multiplier": current_multiplier,
                "time_remaining": 0
            })

        # –ö—Ä–∞—Ö - –∏–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞
        self.is_playing = False
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        await self.save_game_results(multiplier)
        
        await self.ws_manager.send_crash_result({
            "game_id": self.game_id,
            "final_multiplier": multiplier,
            "crashed_at": multiplier,
            "timestamp": datetime.now().isoformat()
        })

    async def save_game_results(self, final_multiplier: float):
        """–°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
        db = SessionLocal()
        try:
            total_players = len(self.bets)
            total_bet = sum(bet['amount'] for bet in self.bets.values())
            total_payout = 0.0
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã
            game_result = crud.create_crash_game_result(
                db=db,
                game_id=self.game_id,
                multiplier=final_multiplier,
                crashed_at=final_multiplier,
                total_players=total_players,
                total_bet=total_bet,
                total_payout=total_payout
            )
            
            db.commit()
            db.refresh(game_result)
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —Å—Ç–∞–≤–∫—É
            for user_id, bet_data in self.bets.items():
                user = crud.get_user_by_id(db, user_id)
                if not user:
                    print(f"‚ùå User {user_id} not found in DB")
                    continue
                
                if 'bet_id' in bet_data:
                    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç–∞–≤–∫–∏
                    if bet_data.get('cashed_out', False):
                        cashout_multiplier = bet_data.get('cashout_multiplier', 1.0)
                        win_amount = bet_data['amount'] * cashout_multiplier
                        status = 'won'
                    elif final_multiplier >= (bet_data.get('auto_cashout', 0) or 0):
                        win_amount = bet_data['amount'] * bet_data['auto_cashout']
                        status = 'won'
                    else:
                        win_amount = 0
                        status = 'lost'
                    
                    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞–≤–∫—É –≤ –ë–î
                    crud.update_crash_bet_result(
                        db=db,
                        bet_id=bet_data['bet_id'],
                        crash_coefficient=final_multiplier,
                        win_amount=win_amount,
                        status=status
                    )
                    
                    # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –≤—ã–∏–≥—Ä—ã—à
                    if win_amount > 0:
                        crud.update_user_balance(
                            db=db,
                            telegram_id=user.telegram_id,
                            currency='stars',
                            amount=win_amount
                        )
                    
                    total_payout += win_amount
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π –≤—ã–∏–≥—Ä—ã—à –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∏–≥—Ä—ã
            game_result.total_payout = total_payout
            db.commit()
            
            print(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: Game ID {self.game_id}")
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–≥—Ä—ã: {e}")
            db.rollback()
        finally:
            db.close()

    async def place_bet(self, user_id: int, amount: float, auto_cashout: float = None):
        """–†–∞–∑–º–µ—â–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î"""
        print(f"üéØ [CrashGame] place_bet called: user_id={user_id}, amount={amount}")

        db = SessionLocal()
        try:
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID
            user = db.query(User).filter(User.id == user_id).first()
            if not user:
                print(f"‚ùå [CrashGame] User {user_id} not found by ID")
                return False

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —Å—Ä–µ–¥—Å—Ç–≤
            if user.stars_balance < amount:
                print(f"‚ùå [CrashGame] Insufficient balance: {user.stars_balance} < {amount}")
                return False

            # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ —Å—Ç–∞–≤–∫–µ –≤ –ë–î
            bet = crud.add_crash_bet(
                db=db,
                user_id=user.id,
                telegram_id=user.telegram_id,
                bet_amount=amount,
                status='pending'
            )

            # –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å –±–∞–ª–∞–Ω—Å–∞
            crud.update_user_balance(
                db=db,
                telegram_id=user.telegram_id,
                currency='stars',
                amount=-amount
            )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏
            self.bets[user.id] = {
                "amount": amount,
                "auto_cashout": auto_cashout,
                "placed_at": datetime.now(),
                "cashed_out": False,
                "profit": 0,
                "bet_id": bet.id
            }

            print(f"‚úÖ [CrashGame] Bet added to active bets: {bet.id}")
            return True

        except Exception as e:
            print(f"‚ùå [CrashGame] Error in place_bet: {e}")
            import traceback
            traceback.print_exc()
            db.rollback()
            return False
        finally:
            db.close()

    async def cash_out(self, user_id: int, cashout_multiplier: float):
        """–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –≤ –ë–î"""
        if user_id not in self.bets:
            raise Exception("No active bet found")
        
        bet_data = self.bets[user_id]
        bet_data['cashed_out'] = True
        bet_data['cashout_multiplier'] = cashout_multiplier
        bet_data['profit'] = bet_data['amount'] * cashout_multiplier
        
        # –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        db = SessionLocal()
        try:
            user = crud.get_user_by_id(db, user_id)
            if user:
                win_amount = bet_data['amount'] * cashout_multiplier
                crud.update_user_balance(
                    db=db,
                    telegram_id=user.telegram_id,
                    currency='stars',
                    amount=win_amount
                )
                db.commit()
        except Exception as e:
            print(f"‚ùå Error in cash_out: {e}")
            db.rollback()
        finally:
            db.close()


–º–æ–¥–µ–ª—å

from sqlalchemy import Column, Integer, String, DateTime, Float, BigInteger, ForeignKey, Index, func, Boolean, Numeric, JSON  
from sqlalchemy.orm import relationship, backref 
from app.database.session import Base


class Wallet(Base):
    __tablename__ = "wallets"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    address = Column(String, unique=True, index=True, nullable=False)
    wallet_provider = Column(String, default="tonconnect")
    is_verified = Column(Boolean, default=False)
    created_at = Column(DateTime, default=func.now())
    
    user = relationship("User", back_populates="wallets")
    transactions = relationship("Transaction", back_populates="wallet")

class Transaction(Base):
    __tablename__ = "transactions"

    id = Column(Integer, primary_key=True, index=True)
    wallet_id = Column(Integer, ForeignKey("wallets.id"), nullable=False, index=True)
    tx_hash = Column(String, unique=True, index=True, nullable=False)
    amount = Column(Numeric(20, 9), nullable=False)
    status = Column(String, default="pending")  # pending, completed, failed
    transaction_type = Column(String)  # deposit, withdrawal
    created_at = Column(DateTime, default=func.now())
    completed_at = Column(DateTime, nullable=True)
    
    wallet = relationship("Wallet", back_populates="transactions")

# –û–±–Ω–æ–≤–∏–º –º–æ–¥–µ–ª—å User –¥–ª—è —Å–≤—è–∑–∏ —Å –∫–æ—à–µ–ª—å–∫–∞–º–∏
class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    telegram_id = Column(BigInteger, unique=True, nullable=False, index=True)
    username = Column(String)
    first_name = Column(String, nullable=True)
    last_name = Column(String, nullable=True)
    photo_url = Column(String, nullable=True)
    referrer_id = Column(Integer, ForeignKey('users.id'), nullable=True, index=True)
    
    # –û—Å–Ω–æ–≤–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã
    ton_balance = Column(Float, default=0.0)
    stars_balance = Column(Float, default=0.0)
    
    # –ö—Ä–∏–ø—Ç–æ –∫–æ—à–µ–ª–µ–∫ (–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    wallet_token = Column(String, nullable=True)
    
    stars_payment_ids = Column(JSON, default=[])  # ‚Üê –í–û–¢ –≠–¢–£ –°–¢–†–û–ß–ö–£
    
    # –Ø–∑—ã–∫ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    language = Column(String, default="ru")
    
    # –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
    referrals_count = Column(Integer, default=0)
    active_referrals = Column(Integer, default=0)
    referral_earnings_usd = Column(Float, default=0.0)
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–¥–∞—Ä–∫–∞–º
    gifts_uploaded = Column(Integer, default=0)
    gift_name_number = Column(String, nullable=True)
    
    # –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º
    stars_earned_from_refs = Column(Float, default=0.0)
    stars_spent_by_refs = Column(Float, default=0.0)
    total_refs_balance = Column(Float, default=0.0)
    
    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    created_at = Column(DateTime, default=func.now())
    updated_at = Column(DateTime, default=func.now(), onupdate=func.now())
    
    # –°–≤—è–∑–∏
    referrer = relationship(
        "User", 
        remote_side=[id],
        backref=backref("referrals", lazy="dynamic"),
        foreign_keys=[referrer_id]
    )
    
    deposits = relationship("DepositHistory", back_populates="user")
    crash_bets = relationship("CrashBetHistory", back_populates="user")
    wallets = relationship("Wallet", back_populates="user")  # –î–æ–±–∞–≤–ª—è–µ–º —Å–≤—è–∑—å —Å –∫–æ—à–µ–ª—å–∫–∞–º–∏


class DepositHistory(Base):
    __tablename__ = "deposit_history"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    telegram_id = Column(BigInteger, nullable=False, index=True)
    
    # –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –¥–µ–ø–æ–∑–∏—Ç–∞
    deposit_datetime = Column(DateTime, default=func.now())
    amount = Column(Float, nullable=False)  # —Å—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞
    note = Column(String, nullable=True)  # –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ
    
    # –°–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    user = relationship("User", back_populates="deposits")
    
    # –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    __table_args__ = (
        Index('idx_deposit_user_date', 'user_id', 'deposit_datetime'),
        Index('idx_deposit_telegram_date', 'telegram_id', 'deposit_datetime'),
    )


class CrashBetHistory(Base):
    __tablename__ = "crash_bet_history"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    telegram_id = Column(BigInteger, nullable=False, index=True)
    
    # –î–∞–Ω–Ω—ã–µ —Å—Ç–∞–≤–∫–∏
    bet_number = Column(Integer, nullable=False)  # –Ω–æ–º–µ—Ä —Å—Ç–∞–≤–∫–∏
    bet_amount = Column(Float, nullable=False)  # —Å—É–º–º–∞ —Å—Ç–∞–≤–∫–∏
    crash_coefficient = Column(Float, nullable=True)  # –≤—ã–∏–≥—Ä—ã—à–Ω—ã–π –∫–æ—ç—Ñ (null –µ—Å–ª–∏ –ø—Ä–æ–∏–≥—Ä—ã—à)
    win_amount = Column(Float, default=0.0)  # –≤—ã–∏–≥—Ä—ã—à–Ω–∞—è —Å—É–º–º–∞
    
    # –°—Ç–∞—Ç—É—Å —Å—Ç–∞–≤–∫–∏
    status = Column(String, default='pending')  # pending, won, lost
    
    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    created_at = Column(DateTime, default=func.now())
    ended_at = Column(DateTime, nullable=True)
    
    # –°–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    user = relationship("User", back_populates="crash_bets")
    
    # –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    __table_args__ = (
        Index('idx_crash_user_date', 'user_id', 'created_at'),
        Index('idx_crash_telegram_date', 'telegram_id', 'created_at'),
        Index('idx_crash_status', 'status'),
    )
    
    
class ReferralAction(Base):
    __tablename__ = "referral_actions"
    
    id = Column(Integer, primary_key=True, index=True)
    referrer_id = Column(Integer, ForeignKey('users.id'), nullable=False, index=True)
    referral_id = Column(Integer, ForeignKey('users.id'), nullable=False, index=True)
    
    action_type = Column(String, nullable=False)  # 'registration', 'deposit', 'bet'
    action_amount = Column(Float, default=0.0)
    reward_amount = Column(Float, default=0.0)
    
    created_at = Column(DateTime, default=func.now())
    
    # –°–≤—è–∑–∏
    referrer = relationship("User", foreign_keys=[referrer_id], backref="referral_actions_made")
    referral = relationship("User", foreign_keys=[referral_id], backref="referral_actions_received")
    
class CrashGameResult(Base):
    __tablename__ = "crash_game_results"

    id = Column(Integer, primary_key=True, index=True)
    game_id = Column(Integer, index=True, nullable=False)
    multiplier = Column(Numeric(10, 2), nullable=False)
    crashed_at = Column(Numeric(10, 2), nullable=False)
    total_players = Column(Integer, default=0)
    total_bet = Column(Numeric(20, 2), default=0.0)
    total_payout = Column(Numeric(20, 2), default=0.0)
    timestamp = Column(DateTime, default=func.now())
    
    # –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    __table_args__ = (
        Index('idx_crash_game_id', 'game_id'),
        Index('idx_crash_timestamp', 'timestamp'),
    )
    
    
class CrashGameSettings(Base):
    __tablename__ = "crash_game_settings"
    
    id = Column(Integer, primary_key=True, index=True)
    rtp = Column(Float, default=0.95)  # 95% RTP –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    house_edge = Column(Float, default=0.05)  # 5% –∫–æ–º–∏—Å—Å–∏—è –¥–æ–º–∞
    min_multiplier = Column(Float, default=1.1)  # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å
    max_multiplier = Column(Float, default=100.0)  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å
    crash_point_distribution = Column(String, default='exponential')  # exponential, uniform, custom
    volatility = Column(Float, default=1.0)  # –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å (1.0 = –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è)
    is_active = Column(Boolean, default=True)
    updated_at = Column(DateTime, default=func.now(), onupdate=func.now())
    
    
    
class AdminSettings(Base):
    __tablename__ = "admin_settings"
    
    id = Column(Integer, primary_key=True, index=True)
    admin_code = Column(String, default="admin123")  # –ü—Ä–æ—Å—Ç–æ–π –∫–æ–¥ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞
    crash_rtp = Column(Float, default=0.95)  # RTP –¥–ª—è –∫—Ä–∞—à–∞
    crash_min_multiplier = Column(Float, default=1.1)
    crash_max_multiplier = Column(Float, default=100.0)
    updated_at = Column(DateTime, default=func.now(), onupdate=func.now())



–∫—Ä—É–¥.py

from sqlalchemy.orm import Session
from sqlalchemy import func
from app.database import models
from app.database.models import User, DepositHistory, CrashBetHistory, Wallet, Transaction, CrashGameResult, CrashGameSettings, AdminSettings
from typing import Optional

def get_user_by_telegram_id(db: Session, telegram_id: int) -> Optional[User]:
    """–ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id"""
    return db.query(User).filter(User.telegram_id == telegram_id).first()

def get_user_by_id(db: Session, user_id: int) -> Optional[User]:
    """–ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID"""
    return db.query(User).filter(User.id == user_id).first()

def add_stars_payment_id(db: Session, telegram_id: int, payment_id: str) -> bool:
    """–î–æ–±–∞–≤–ª—è–µ–º ID –ø–ª–∞—Ç–µ–∂–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user = get_user_by_telegram_id(db, telegram_id)
    if not user:
        return False
    
    if user.stars_payment_ids is None:
        user.stars_payment_ids = []
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –¥–æ–±–∞–≤–ª—è–ª–∏ –ª–∏ —É–∂–µ —ç—Ç–æ—Ç ID
    if payment_id not in user.stars_payment_ids:
        user.stars_payment_ids.append(payment_id)
        db.commit()
        return True
    
    return False




def has_stars_payment_id(db: Session, telegram_id: int, payment_id: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π ID –ø–ª–∞—Ç–µ–∂–∞"""
    user = get_user_by_telegram_id(db, telegram_id)
    if not user or not user.stars_payment_ids:
        return False
    
    return payment_id in user.stars_payment_ids
def create_user(
    db: Session, 
    telegram_id: int, 
    username: Optional[str] = None,
    first_name: Optional[str] = None,
    last_name: Optional[str] = None,
    referrer_id: Optional[int] = None,
    language: str = 'ru',
    photo_url: str = None 
) -> User:
    """–°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—á–µ—Ç–æ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã"""
    db_user = User(
        telegram_id=telegram_id,
        username=username,
        first_name=first_name,
        last_name=last_name,
        referrer_id=referrer_id,
        language=language,
        photo_url=photo_url
    )
    
    db.add(db_user)
    db.commit()
    db.refresh(db_user)
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ—Ñ–µ—Ä–µ—Ä, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ —Å—á–µ—Ç—á–∏–∫–∏
    if referrer_id:
        update_referrer_stats(db, referrer_id)
    
    return db_user

def update_user_language(db: Session, telegram_id: int, language: str):
    """–û–±–Ω–æ–≤–ª—è–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user = get_user_by_telegram_id(db, telegram_id)
    if not user:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —è–∑—ã–∫–æ–º
        return create_user(db, telegram_id, language=language)
    
    user.language = language
    db.commit()
    db.refresh(user)
    return user

def update_referrer_stats(db: Session, referrer_id: int):
    """–û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–µ—Ñ–µ—Ä–µ—Ä–∞"""
    referrer = db.query(User).filter(User.id == referrer_id).first()
    if referrer:
        referrer.referrals_count = db.query(User).filter(
            User.referrer_id == referrer_id
        ).count()
        referrer.active_referrals = db.query(User).filter(
            User.referrer_id == referrer_id,
            User.ton_balance > 0
        ).count()
        db.commit()

def update_user_balance(
    db: Session, 
    telegram_id: int, 
    currency: str, 
    amount: float
) -> Optional[User]:
    """–û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user = get_user_by_telegram_id(db, telegram_id)
    if not user:
        return None
    
    if currency == 'ton':
        user.ton_balance += amount
    elif currency == 'stars':
        user.stars_balance += amount
    
    db.commit()
    db.refresh(user)
    return user

def get_user_balance(db: Session, telegram_id: int) -> dict:
    """–ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user = get_user_by_telegram_id(db, telegram_id)
    if not user:
        return {'ton': 0.0, 'stars': 0.0}
    
    return {'ton': user.ton_balance, 'stars': user.stars_balance}

def add_deposit_history(
    db: Session,
    user_id: int,
    telegram_id: int,
    amount: float,
    note: Optional[str] = None
) -> DepositHistory:
    """–î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–µ–ø–æ–∑–∏—Ç–æ–≤"""
    deposit = DepositHistory(
        user_id=user_id,
        telegram_id=telegram_id,
        amount=amount,
        note=note
    )
    
    db.add(deposit)
    db.commit()
    db.refresh(deposit)
    return deposit

def add_crash_bet(
    db: Session,
    user_id: int,
    telegram_id: int,
    bet_amount: float,
    crash_coefficient: Optional[float] = None,
    win_amount: float = 0.0,
    status: str = 'pending'
) -> CrashBetHistory:
    """–î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ —Å—Ç–∞–≤–∫–µ –≤ crash –∏–≥—Ä—É"""
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–æ–º–µ—Ä —Å—Ç–∞–≤–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    last_bet = db.query(CrashBetHistory).filter(
        CrashBetHistory.user_id == user_id
    ).order_by(CrashBetHistory.bet_number.desc()).first()
    
    next_bet_number = (last_bet.bet_number + 1) if last_bet else 1
    
    bet = CrashBetHistory(
        user_id=user_id,
        telegram_id=telegram_id,
        bet_number=next_bet_number,
        bet_amount=bet_amount,
        crash_coefficient=crash_coefficient,
        win_amount=win_amount,
        status=status
    )
    
    db.add(bet)
    db.commit()
    db.refresh(bet)
    return bet


def get_user_crash_bet_history(db: Session, user_id: int, limit: int = 50):
    """–ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å—Ç–∞–≤–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    return db.query(CrashBetHistory).filter(
        CrashBetHistory.user_id == user_id
    ).order_by(
        CrashBetHistory.created_at.desc()
    ).limit(limit).all()

def get_all_crash_bet_history(db: Session, limit: int = 100):
    """–ü–æ–ª—É—á–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Å—Ç–∞–≤–æ–∫"""
    return db.query(CrashBetHistory).order_by(
        CrashBetHistory.created_at.desc()
    ).limit(limit).all()

def get_crash_bet_by_id(db: Session, bet_id: int):
    """–ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞–≤–∫—É –ø–æ ID"""
    return db.query(CrashBetHistory).filter(CrashBetHistory.id == bet_id).first()

def get_user_active_crash_bets(db: Session, user_id: int):
    """–ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    return db.query(CrashBetHistory).filter(
        CrashBetHistory.user_id == user_id,
        CrashBetHistory.status == 'pending'
    ).all()

def get_wallet_by_address(db: Session, address: str):
    return db.query(Wallet).filter(Wallet.address == address).first()

def get_pending_transactions(db: Session, user_id: int):
    """–ü–æ–ª—É—á–∞–µ–º pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    return db.query(Transaction).filter(
        Transaction.wallet_id.in_(
            db.query(Wallet.id).filter(Wallet.user_id == user_id)
        ),
        Transaction.status == "pending"
    ).all()

def get_wallet_by_user(db: Session, user_id: int):
    return db.query(Wallet).filter(Wallet.user_id == user_id).first()

def create_wallet(db: Session, user_id: int, address: str, wallet_provider: str = "tonconnect"):
    db_wallet = Wallet(
        user_id=user_id,
        address=address,
        wallet_provider=wallet_provider
    )
    db.add(db_wallet)
    db.commit()
    db.refresh(db_wallet)
    return db_wallet

def create_transaction(db: Session, wallet_id: int, tx_hash: str, amount: float, transaction_type: str):
    db_transaction = Transaction(
        wallet_id=wallet_id,
        tx_hash=tx_hash,
        amount=amount,
        transaction_type=transaction_type
    )
    db.add(db_transaction)
    db.commit()
    db.refresh(db_transaction)
    return db_transaction

def get_transaction_by_hash(db: Session, tx_hash: str):
    return db.query(Transaction).filter(Transaction.tx_hash == tx_hash).first()

def update_transaction_status(db: Session, tx_hash: str, status: str):
    db_transaction = get_transaction_by_hash(db, tx_hash)
    if db_transaction:
        db_transaction.status = status
        if status == "completed":
            db_transaction.completed_at = func.now()
        db.commit()
        db.refresh(db_transaction)
    return db_transaction

def get_user_wallets(db: Session, user_id: int):
    return db.query(Wallet).filter(Wallet.user_id == user_id).all()

def create_crash_game_result(db: Session, game_id: int, multiplier: float, crashed_at: float, 
                           total_players: int = 0, total_bet: float = 0.0, total_payout: float = 0.0):
    """–°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∫—Ä–∞—à-–∏–≥—Ä—ã"""
    db_result = CrashGameResult(
        game_id=game_id,
        multiplier=multiplier,
        crashed_at=crashed_at,
        total_players=total_players,
        total_bet=total_bet,
        total_payout=total_payout
    )
    db.add(db_result)
    db.commit()
    db.refresh(db_result)
    return db_result

def update_crash_bet_result(db: Session, bet_id: int, crash_coefficient: float, 
                          win_amount: float, status: str):
    """–û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç–∞–≤–∫–∏ –≤ –∫—Ä–∞—à-–∏–≥—Ä–µ"""
    bet = db.query(CrashBetHistory).filter(CrashBetHistory.id == bet_id).first()
    if bet:
        bet.crash_coefficient = crash_coefficient
        bet.win_amount = win_amount
        bet.status = status
        bet.ended_at = func.now()
        db.commit()
        db.refresh(bet)
    return bet

def get_user_active_crash_bets(db: Session, user_id: int):
    """–ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫—Ä–∞—à-–∏–≥—Ä–µ"""
    return db.query(CrashBetHistory).filter(
        CrashBetHistory.user_id == user_id,
        CrashBetHistory.status == 'pending'
    ).all()

def get_crash_game_history(db: Session, limit: int = 50):
    """–ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫—Ä–∞—à-–∏–≥—Ä"""
    return db.query(CrashGameResult).order_by(
        CrashGameResult.timestamp.desc()
    ).limit(limit).all()

get_user = get_user_by_telegram_id


def add_stars_payment_id(db: Session, telegram_id: int, payment_id: str) -> bool:
    """–î–æ–±–∞–≤–ª—è–µ–º ID –ø–ª–∞—Ç–µ–∂–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user = get_user_by_telegram_id(db, telegram_id)
    if not user:
        return False
    
    if user.stars_payment_ids is None:
        user.stars_payment_ids = []
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –¥–æ–±–∞–≤–ª—è–ª–∏ –ª–∏ —É–∂–µ —ç—Ç–æ—Ç ID
    if payment_id not in user.stars_payment_ids:
        user.stars_payment_ids.append(payment_id)
        db.commit()
        return True
    
    return False

def has_stars_payment_id(db: Session, telegram_id: int, payment_id: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π ID –ø–ª–∞—Ç–µ–∂–∞"""
    user = get_user_by_telegram_id(db, telegram_id)
    if not user or not user.stars_payment_ids:
        return False
    
    return payment_id in user.stars_payment_ids


def get_crash_game_settings(db: Session):
    """–ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã"""
    return db.query(CrashGameSettings).first()

def update_crash_game_settings(db: Session, settings_data: dict):
    """–û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã"""
    settings = db.query(CrashGameSettings).first()
    
    if not settings:
        settings = CrashGameSettings()
        db.add(settings)
    
    for key, value in settings_data.items():
        if hasattr(settings, key):
            setattr(settings, key, value)
    
    db.commit()
    db.refresh(settings)
    return settings

def get_game_stats(db: Session):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ RTP"""
    from sqlalchemy import func
    
    total_games = db.query(func.count(CrashGameResult.id)).scalar()
    total_bet = db.query(func.sum(CrashGameResult.total_bet)).scalar() or 0
    total_payout = db.query(func.sum(CrashGameResult.total_payout)).scalar() or 0
    
    actual_rtp = (total_payout / total_bet) if total_bet > 0 else 0
    
    return {
        "total_games": total_games,
        "total_bet": float(total_bet),
        "total_payout": float(total_payout),
        "house_profit": float(total_bet - total_payout),
        "actual_rtp": float(actual_rtp)
    }
    
def get_admin_settings(db: Session):
    """–ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–∫–∏"""
    return db.query(AdminSettings).first()

def update_admin_settings(db: Session, admin_code: str = None, 
                         crash_rtp: float = None, 
                         crash_min_multiplier: float = None,
                         crash_max_multiplier: float = None):
    """–û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–∫–∏"""
    settings = db.query(AdminSettings).first()
    
    if not settings:
        settings = AdminSettings()
        db.add(settings)
    
    if admin_code is not None:
        settings.admin_code = admin_code
    if crash_rtp is not None:
        settings.crash_rtp = crash_rtp
    if crash_min_multiplier is not None:
        settings.crash_min_multiplier = crash_min_multiplier
    if crash_max_multiplier is not None:
        settings.crash_max_multiplier = crash_max_multiplier
    
    db.commit()
    db.refresh(settings)
    return settings



admin.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from app.database.session import get_db
from app.dependencies import get_current_admin, require_permission
from app.database import crud

router = APIRouter(prefix="/admin", tags=["admin"])

@router.get("/crash-settings")
async def get_crash_settings(
    db: Session = Depends(get_db),
    admin: dict = Depends(require_permission("manage_games"))
):
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—Ä–∞—à-–∏–≥—Ä—ã"""
    settings = crud.get_crash_game_settings(db)
    if not settings:
        raise HTTPException(404, "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
    
    return {
        "rtp": settings.rtp,
        "house_edge": settings.house_edge,
        "min_multiplier": settings.min_multiplier,
        "max_multiplier": settings.max_multiplier,
        "crash_point_distribution": settings.crash_point_distribution,
        "volatility": settings.volatility,
        "is_active": settings.is_active
    }

@router.post("/crash-settings")
async def update_crash_settings(
    settings_data: dict,
    db: Session = Depends(get_db),
    admin: dict = Depends(require_permission("manage_games"))
):
    """–û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—Ä–∞—à-–∏–≥—Ä—ã"""
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        if 'rtp' in settings_data and not (0.5 <= settings_data['rtp'] <= 0.99):
            raise HTTPException(400, "RTP –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–∂–¥—É 0.5 –∏ 0.99")
        
        if 'house_edge' in settings_data and not (0.01 <= settings_data['house_edge'] <= 0.5):
            raise HTTPException(400, "–ö–æ–º–∏—Å—Å–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–∂–¥—É 1% –∏ 50%")
        
        settings = crud.update_crash_game_settings(db, settings_data)
        
        return {
            "status": "success",
            "message": "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã",
            "settings": {
                "rtp": settings.rtp,
                "house_edge": settings.house_edge,
                "min_multiplier": settings.min_multiplier,
                "max_multiplier": settings.max_multiplier,
                "volatility": settings.volatility,
                "distribution": settings.crash_point_distribution
            }
        }
        
    except Exception as e:
        raise HTTPException(500, f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: {str(e)}")

@router.get("/game-stats")
async def get_game_stats(
    db: Session = Depends(get_db),
    admin: dict = Depends(require_permission("view_stats"))
):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã –¥–ª—è –∞–¥–º–∏–Ω–∫–∏"""
    stats = crud.get_game_stats(db)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    settings = crud.get_crash_game_settings(db)
    stats["theoretical_rtp"] = settings.rtp if settings else 0.95
    stats["house_edge"] = settings.house_edge if settings else 0.05
    
    return stats